name: Setup mongodb
on:
  push:
    branches:
      - develop
env:
  MONGO_INITDB_DATABASE: users
  MONGO_INITDB_ROOT_USERNAME: admin
  MONGO_INITDB_ROOT_PASSWORD: secret
  MONGO_DB_HOST: mongodb
jobs:
  getter:
    name: "get the code"
    runs-on: ubuntu-latest
    steps:
      - name: Get the code
        uses: actions/checkout@v3
  display:
    name: "display environments variables"
    needs: getter
    runs-on: ubuntu-latest
    steps:
      - name: display environment vaiables
        run: |
          echo "MONGO_INITDB_DATABASE: $MONGO_INITDB_DATABASE
          MONGO_INITDB_ROOT_USERNAME: $MONGO_INITDB_ROOT_USERNAME
          MONGO_INITDB_ROOT_PASSWORD: $MONGO_INITDB_ROOT_PASSWORD
          MONGO_DB_HOST: $MONGO_DB_HOST"
  runner:
    needs: display
    id: runner-job
    name: "run mongodb container"
    runs-on: ubuntu-latest
    steps:
        - name: Run mongodb container
        id: runner
        run: |
          docker run --name mongodb \
          -e MONGO_INITDB_DATABASE=$MONGO_INITDB_DATABASE \
          -e MONGO_INITDB_ROOT_USERNAME=$MONGO_INITDB_ROOT_USERNAME \
          -e MONGO_INITDB_ROOT_PASSWORD=$MONGO_INITDB_ROOT_PASSWORD \
          -e MONGO_DB_HOST=$MONGO_DB_HOST \
          --rm \
          -d \
          mongo
  checker:
    needs: runner
    name: "check mongo container status"
    runs-on: ubuntu-latest
    if: success() && ${{ needs.runner-job.steps.runner.outcome.success }}
    steps:
      - name: check mongo container status
        run: echo "mongodb container is healthy"
